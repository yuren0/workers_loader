<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Moonå½±è§†æœç´¢</title>
    
    <!-- ä½¿ç”¨å®˜æ–¹CDNï¼Œç¡®ä¿ç¨³å®šæ€§ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/hls.js/1.6.13/hls.min.js"></script>
    
    <!-- Tailwindé…ç½® -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#6366F1',
                        secondary: '#818CF8',
                        dark: '#1E293B',
                        light: '#F8FAFC'
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif']
                    }
                }
            }
        }
    </script>
    
    <!-- åŸºç¡€æ ·å¼ -->
    <style>
        body {
            font-family: 'Inter', system-ui, sans-serif;
        }
        
        .movie-card {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        
        .movie-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
        }
        
        .movie-poster {
            aspect-ratio: 2/3;
            object-fit: cover;
        }
        
        .episode-btn {
            transition: all 0.2s ease;
        }
        
        .episode-btn:hover {
            background-color: #6366F1;
            color: white;
        }
        
        .episode-btn.active {
            background-color: #6366F1;
            color: white;
        }
        
        /* è§†é¢‘æ’­æ”¾å™¨æ§åˆ¶æ æ ·å¼ */
        .video-container {
            position: relative;
            width: 100%;
            height: 0;
            padding-bottom: 56.25%; /* 16:9 å®½é«˜æ¯” */
        }
        
        .video-container video {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- é¡µé¢å®¹å™¨ -->
    <div class="container mx-auto px-4 py-6">
        <!-- å¤´éƒ¨æœç´¢åŒºåŸŸ -->
        <header class="mb-8">
            <div class="text-center mb-6">
                <h1 class="text-3xl font-bold text-primary flex items-center justify-center">
                    <i class="fa fa-film mr-2"></i>Moonå½±è§†æœç´¢
                </h1>
                <p class="text-gray-500 mt-2">æœç´¢å¹¶è§‚çœ‹æ‚¨å–œçˆ±çš„ç”µå½±å’Œç”µè§†å‰§</p>
            </div>
            
            <!-- æœç´¢æ¡† -->
            <div class="max-w-2xl mx-auto">
                <div class="relative">
                    <input 
                        id="searchInput" 
                        type="text" 
                        placeholder="è¾“å…¥ç”µå½±æˆ–ç”µè§†å‰§åç§°..." 
                        class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all"
                        maxlength="50"
                    >
                    <button 
                        id="searchBtn" 
                        class="absolute right-2 top-1/2 transform -translate-y-1/2 bg-primary hover:bg-secondary text-white px-4 py-2 rounded-lg transition-all"
                    >
                        <i class="fa fa-search mr-1"></i>æœç´¢
                    </button>
                </div>
                
                <!-- APIé€‰æ‹©å™¨ -->
                <div class="mt-4 flex items-center justify-center">
                    <label for="apiSelector" class="text-sm text-gray-600 mr-2">é€‰æ‹©æ•°æ®æºï¼š</label>
                    <select id="apiSelector" class="px-3 py-2 border border-gray-300 rounded-lg text-sm bg-white focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary">
                        <option value="https://corsapi-no18.yuren0.us.kg/?url=https://iqiyizyapi.com/api.php/provide/vod/?ac=videolist&wd=">ğŸ¬çˆ±å¥‡è‰ºæº</option>
                        <option value="https://corsapi-no18.yuren0.us.kg/?url=https://caiji.dbzy5.com/api.php/provide/vod/?ac=videolist&wd=">ğŸ¬è±†ç“£èµ„æº</option>
                        <option value="https://corsapi-no18.yuren0.us.kg/?url=https://tyyszy.com/api.php/provide/vod/?ac=videolist&wd=">ğŸ¬å¤©æ¶¯å½±è§†</option>
                    </select>
                </div>
            </div>
        </header>
        
        <!-- ä¸»å†…å®¹åŒº -->
        <main>
            <!-- æ¬¢è¿ä¿¡æ¯ -->
            <div id="welcomeSection" class="text-center py-16">
                <i class="fa fa-film text-primary text-6xl mb-6"></i>
                <h2 class="text-2xl font-bold text-gray-800 mb-2">å¼€å§‹æ‚¨çš„è§‚å½±ä¹‹æ—…</h2>
                <p class="text-gray-600">åœ¨ä¸Šæ–¹æœç´¢æ¡†è¾“å…¥ç”µå½±æˆ–ç”µè§†å‰§åç§°ï¼Œå³åˆ»å¼€å§‹æœç´¢</p>
            </div>
            
            <!-- ä¿®æ”¹æœç´¢ç»“æœä¿¡æ¯åŒºåŸŸ -->
            <div id="searchInfo" class="mb-4 text-gray-600 hidden">
                æœç´¢ "<span id="searchKeyword" class="font-medium text-primary"></span>" çš„ç»“æœ
                <span id="resultCount" class="ml-2 text-gray-500"></span>
            </div>
            
            <!-- åˆ†é¡µæ§ä»¶ -->
            <div id="paginationControls" class="flex justify-between items-center mt-6 mb-4 hidden">
                <div id="pageInfo" class="text-sm text-gray-500"></div>
                <div class="flex gap-2">
                    <button id="prevPageBtn" class="px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded-md disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                        <i class="fa fa-chevron-left mr-1"></i> ä¸Šä¸€é¡µ
                    </button>
                    <button id="nextPageBtn" class="px-4 py-2 bg-primary hover:bg-primary/90 text-white rounded-md disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                        ä¸‹ä¸€é¡µ <i class="fa fa-chevron-right ml-1"></i>
                    </button>
                </div>
            </div>
            
            <!-- åŠ è½½çŠ¶æ€ -->
            <div id="loadingIndicator" class="hidden flex justify-center items-center py-16">
                <div class="animate-spin rounded-full h-12 w-12 border-t-4 border-b-4 border-primary"></div>
            </div>
            
            <!-- é”™è¯¯æç¤º -->
            <div id="errorMessage" class="hidden p-4 bg-red-50 border border-red-200 rounded-lg text-red-600 mb-6">
                <i class="fa fa-exclamation-circle mr-2"></i>
                <span id="errorText">åŠ è½½å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•</span>
                <button id="retryBtn" class="ml-4 px-4 py-1 bg-primary hover:bg-primary/90 text-white rounded-md">
                    ç«‹å³é‡è¯•
                </button>
            </div>
            
            <!-- æœç´¢ç»“æœç½‘æ ¼ -->
            <div id="resultsGrid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-4">
                <!-- æœç´¢ç»“æœå°†åŠ¨æ€æ’å…¥è¿™é‡Œ -->
            </div>
            
            <!-- åº•éƒ¨æœç´¢ç»“æœä¿¡æ¯åŒºåŸŸ -->
            <div id="bottomSearchInfo" class="mb-4 text-gray-600 hidden mt-8">
                æœç´¢ "<span id="bottomSearchKeyword" class="font-medium text-primary"></span>" çš„ç»“æœ
                <span id="bottomResultCount" class="ml-2 text-gray-500"></span>
            </div>
            
            <!-- åº•éƒ¨åˆ†é¡µæ§ä»¶ -->
            <div id="bottomPaginationControls" class="flex justify-between items-center mt-6 mb-4 hidden">
                <div id="bottomPageInfo" class="text-sm text-gray-500"></div>
                <div class="flex gap-2">
                    <button id="bottomPrevPageBtn" class="px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded-md disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                        <i class="fa fa-chevron-left mr-1"></i> ä¸Šä¸€é¡µ
                    </button>
                    <button id="bottomNextPageBtn" class="px-4 py-2 bg-primary hover:bg-primary/90 text-white rounded-md disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                        ä¸‹ä¸€é¡µ <i class="fa fa-chevron-right ml-1"></i>
                    </button>
                </div>
            </div>
            
            <!-- ç©ºçŠ¶æ€ -->
            <div id="emptyState" class="hidden py-16 text-center">
                <i class="fa fa-search text-gray-300 text-5xl mb-4"></i>
                <p class="text-gray-500 text-lg">æœªæ‰¾åˆ°ç›¸å…³å†…å®¹</p>
                <p class="text-gray-400 mt-2">è¯·å°è¯•ä½¿ç”¨å…¶ä»–å…³é”®è¯æˆ–æ•°æ®æº</p>
            </div>
        </main>
    </div>
    
    <!-- ç”µå½±è¯¦æƒ…æ¨¡æ€æ¡† -->
    <div id="movieModal" class="fixed inset-0 bg-black/80 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-lg max-w-5xl w-full max-h-[95vh] overflow-hidden flex flex-col">
            <!-- æ¨¡æ€æ¡†å¤´éƒ¨ -->
            <div class="p-4 border-b flex justify-between items-center">
                <h2 id="modalTitle" class="text-xl font-bold text-gray-800"></h2>
                <button id="closeModal" class="text-gray-500 hover:text-gray-700 text-xl">
                    <i class="fa fa-times"></i>
                </button>
            </div>
            
            <!-- æ¨¡æ€æ¡†å†…å®¹ -->
            <div class="overflow-y-auto flex-grow">
                <!-- è§†é¢‘æ’­æ”¾å™¨ -->
                <div class="relative bg-black">
                    <div class="video-container">
                        <video 
                            id="videoPlayer" 
                            controls 
                            playsinline
                            webkit-playsinline
                        >
                            æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒHTML5è§†é¢‘æ’­æ”¾
                        </video>
                    </div>
                </div>
                
                <!-- é›†æ•°é€‰æ‹© -->
                <div class="p-4 border-b">
                    <h3 class="font-medium mb-3">é€‰é›†ï¼š</h3>
                    <div class="flex flex-wrap gap-2" id="episodeContainer">
                        <!-- é›†æ•°æŒ‰é’®å°†åŠ¨æ€ç”Ÿæˆ -->
                    </div>
                </div>
                
                <!-- ç”µå½±è¯¦æƒ…ä¿¡æ¯ -->
                <div class="p-4">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="md:col-span-1">
                            <img id="movieImage" src="" alt="ç”µå½±å°é¢" class="w-full rounded-lg shadow-md">
                        </div>
                        <div class="md:col-span-2">
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                <div>
                                    <p class="text-sm text-gray-500">ç±»å‹</p>
                                    <p id="movieType" class="font-medium"></p>
                                </div>
                                <div>
                                    <p class="text-sm text-gray-500">åœ°åŒº</p>
                                    <p id="movieArea" class="font-medium"></p>
                                </div>
                                <div>
                                    <p class="text-sm text-gray-500">å¹´ä»½</p>
                                    <p id="movieYear" class="font-medium"></p>
                                </div>
                                <div>
                                    <p class="text-sm text-gray-500">å¯¼æ¼”</p>
                                    <p id="movieDirector" class="font-medium"></p>
                                </div>
                                <div class="sm:col-span-2">
                                    <p class="text-sm text-gray-500">ä¸»æ¼”</p>
                                    <p id="movieActor" class="font-medium"></p>
                                </div>
                                <div class="sm:col-span-2">
                                    <p class="text-sm text-gray-500">ç®€ä»‹</p>
                                    <p id="movieContent" class="font-medium text-gray-700 mt-1"></p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- JavaScript -->
    <script>
        // å…¨å±€å˜é‡
        let player = null;
        let hls = null;
        let currentMovieData = null;
        let currentPage = 1;
        let totalCount = 0;
        let currentSearchKeyword = '';
        let cumulativeResultCount = 0; // ç”¨äºç´¯è®¡ç»“æœæ•°
        
        // DOMå…ƒç´ 
        const searchInput = document.getElementById('searchInput');
        const searchBtn = document.getElementById('searchBtn');
        const apiSelector = document.getElementById('apiSelector');
        const resultsGrid = document.getElementById('resultsGrid');
        const welcomeSection = document.getElementById('welcomeSection');
        const searchInfo = document.getElementById('searchInfo');
        const searchKeyword = document.getElementById('searchKeyword');
        const resultCount = document.getElementById('resultCount'); // ç¡®ä¿è¿™ä¸ªå…ƒç´ å­˜åœ¨
        const pageInfo = document.getElementById('pageInfo');
        const paginationControls = document.getElementById('paginationControls');
        const prevPageBtn = document.getElementById('prevPageBtn');
        const nextPageBtn = document.getElementById('nextPageBtn');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const errorMessage = document.getElementById('errorMessage');
        const errorText = document.getElementById('errorText');
        const retryBtn = document.getElementById('retryBtn'); // æ–°å¢é‡è¯•æŒ‰é’®
        const emptyState = document.getElementById('emptyState');
        const movieModal = document.getElementById('movieModal');
        const closeModal = document.getElementById('closeModal');
        const modalTitle = document.getElementById('modalTitle');
        const movieImage = document.getElementById('movieImage');
        const movieType = document.getElementById('movieType');
        const movieArea = document.getElementById('movieArea');
        const movieYear = document.getElementById('movieYear');
        const movieDirector = document.getElementById('movieDirector');
        const movieActor = document.getElementById('movieActor');
        const movieContent = document.getElementById('movieContent');
        const episodeContainer = document.getElementById('episodeContainer');
        // åº•éƒ¨åˆ†é¡µå…ƒç´ 
        const bottomPaginationControls = document.getElementById('bottomPaginationControls');
        const bottomPageInfo = document.getElementById('bottomPageInfo');
        const bottomPrevPageBtn = document.getElementById('bottomPrevPageBtn');
        const bottomNextPageBtn = document.getElementById('bottomNextPageBtn');
        // åº•éƒ¨æœç´¢ä¿¡æ¯å…ƒç´ 
        const bottomSearchInfo = document.getElementById('bottomSearchInfo');
        const bottomSearchKeyword = document.getElementById('bottomSearchKeyword');
        const bottomResultCount = document.getElementById('bottomResultCount');
        
        // åˆå§‹åŒ–è§†é¢‘æ’­æ”¾å™¨
        function initVideoPlayer() {
            const video = document.getElementById('videoPlayer');
            if (Hls.isSupported()) {
                hls = new Hls();
            } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
                // å¯¹äºSafariæµè§ˆå™¨ï¼ŒåŸç”Ÿæ”¯æŒHLS
                console.log('ä½¿ç”¨SafariåŸç”ŸHLSæ”¯æŒ');
            } else {
                console.error('è¯¥æµè§ˆå™¨ä¸æ”¯æŒHLSæ’­æ”¾');
                alert('æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒHLSè§†é¢‘æ’­æ”¾');
            }
        }
        
        // æœç´¢å‡½æ•°
        function searchMovies(keyword, page = 1) {
            // ä¿å­˜å½“å‰æœç´¢çŠ¶æ€
            currentSearchKeyword = keyword;
            currentPage = page;
            
            // é‡ç½®UIçŠ¶æ€
            resetUI();
            
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            loadingIndicator.classList.remove('hidden');
            welcomeSection.classList.add('hidden');
            
            // URLç¼–ç å…³é”®è¯
            const encodedKeyword = encodeURIComponent(keyword);
            searchKeyword.textContent = keyword;
            
            // æ„å»ºAPI URLï¼Œæ·»åŠ åˆ†é¡µå‚æ•°
            const apiUrl = apiSelector.value;
            const searchUrl = `${apiUrl}${encodedKeyword}&pg=${page}`;
            
            // ä½¿ç”¨XMLHttpRequestç¡®ä¿æ›´å¥½çš„å…¼å®¹æ€§
            const xhr = new XMLHttpRequest();
            xhr.open('GET', searchUrl, true);
            xhr.timeout = 15000; // 15ç§’è¶…æ—¶
            
            xhr.onload = function() {
                loadingIndicator.classList.add('hidden');
                
                if (xhr.status === 200) {
                    try {
                        const response = JSON.parse(xhr.responseText);
                        
                        // å°è¯•ä»å“åº”ä¸­è·å–æ€»èµ„æºæ•°ï¼ˆå°è¯•å¤šç§å¯èƒ½çš„å­—æ®µåï¼‰
                        totalCount = 0;
                        const possibleTotalFields = ['total', 'pagecount', 'count', 'totalcount', 'totalCount', 'allcount', 'total_num', 'num_total'];
                        
                        for (const field of possibleTotalFields) {
                            if (response[field] !== undefined && response[field] !== null && !isNaN(Number(response[field]))) {
                                totalCount = Number(response[field]);
                                break;
                            }
                        }
                        
                        // è®¡ç®—ç´¯è®¡ç»“æœæ•°
                        const currentResultCount = response.list ? response.list.length : 0;
                        // å¦‚æœæ˜¯ç¬¬ä¸€é¡µï¼Œåˆ™é‡æ–°å¼€å§‹è®¡æ•°ï¼›å¦åˆ™ç´¯åŠ ä¸Šä¸€é¡µçš„ç»“æœæ•°
                        if (page === 1) {
                            cumulativeResultCount = currentResultCount;
                        } else {
                            // æ ¹æ®é¡µé¢è®¡ç®—ç´¯è®¡ç»“æœæ•°
                            cumulativeResultCount = (page - 1) * 20 + currentResultCount; // å‡è®¾æ¯é¡µ20ä¸ªé¡¹ç›®
                        }
                        
                        if (response.code === 1 && response.list && response.list.length > 0) {
                            // æœ‰æœç´¢ç»“æœ
                            searchInfo.classList.remove('hidden');
                            bottomSearchInfo.classList.remove('hidden');
                            paginationControls.classList.remove('hidden');
                            
                            // ç›´æ¥åœ¨é¡µé¢ä¸Šæ›´æ–°èµ„æºæ•°é‡æ˜¾ç¤º
                            if (resultCount) {
                                resultCount.textContent = `(æ€»èµ„æºæ•°: ${totalCount || 0}ï¼Œå½“å‰èµ„æºæ•°: ${currentResultCount}ï¼Œç´¯è®¡èµ„æºæ•°: ${cumulativeResultCount})`;
                            }
                            
                            // æ›´æ–°åº•éƒ¨æœç´¢å…³é”®è¯
                            if (bottomSearchKeyword) {
                                bottomSearchKeyword.textContent = keyword;
                            }
                            
                            displaySearchResults(response.list, cumulativeResultCount);
                            updatePaginationControls();
                        } else {
                            // æ— æœç´¢ç»“æœ
                            emptyState.classList.remove('hidden');
                        }
                    } catch (parseError) {
                        showError('æ•°æ®è§£æå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
                        console.error('JSONè§£æé”™è¯¯:', parseError);
                    }
                } else {
                    showError(`è¯·æ±‚å¤±è´¥ï¼ŒçŠ¶æ€ç : ${xhr.status}`);
                }
            };
            
            xhr.onerror = function() {
                loadingIndicator.classList.add('hidden');
                showError('ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè®¾ç½®');
            };
            
            xhr.ontimeout = function() {
                loadingIndicator.classList.add('hidden');
                showError('è¯·æ±‚è¶…æ—¶ï¼Œè¯·ç¨åé‡è¯•');
            };
            
            xhr.send();
        }
        
        // æ˜¾ç¤ºæœç´¢ç»“æœ
        function displaySearchResults(movies, cumulativeCount) {
            resultsGrid.innerHTML = '';
            
            // ç¡®ä¿åœ¨é¡µé¢ä¸Šæ˜¾ç¤ºèµ„æºæ•°é‡ï¼ˆåŒé‡ä¿éšœï¼‰
            if (resultCount) {
                resultCount.textContent = `(æ€»èµ„æºæ•°: ${totalCount || 0}ï¼Œç´¯è®¡èµ„æºæ•°: ${cumulativeCount})`;
            }
            
            // æ›´æ–°åº•éƒ¨èµ„æºæ•°é‡æ˜¾ç¤º
            if (bottomResultCount) {
                bottomResultCount.textContent = `(æ€»èµ„æºæ•°: ${totalCount || 0}ï¼Œç´¯è®¡èµ„æºæ•°: ${cumulativeCount})`;
            }
            
            // æ›´æ–°é¡µç ä¿¡æ¯
            if (pageInfo) {
                pageInfo.textContent = `ç¬¬ ${currentPage} é¡µ`;
            }
            
            // æ›´æ–°åº•éƒ¨åˆ†é¡µä¿¡æ¯
            if (bottomPageInfo) {
                bottomPageInfo.textContent = `ç¬¬ ${currentPage} é¡µ`;
            }
            
            // æ›´æ–°åº•éƒ¨æœç´¢å…³é”®è¯
            if (bottomSearchKeyword) {
                bottomSearchKeyword.textContent = currentSearchKeyword;
            }
            
            movies.forEach(movie => {
                // åˆ›å»ºç”µå½±å¡ç‰‡
                const card = document.createElement('div');
                card.className = 'movie-card bg-white rounded-lg overflow-hidden shadow cursor-pointer';
                
                // å¡«å……å¡ç‰‡å†…å®¹
                const poster = movie.vod_pic || 'https://via.placeholder.com/300x450?text=æš‚æ— å°é¢';
                const title = movie.vod_name || 'æœªçŸ¥å½±ç‰‡';
                const type = movie.type_name || movie.vod_class || 'æœªçŸ¥ç±»å‹';
                const year = movie.vod_year || 'æœªçŸ¥å¹´ä»½';
                
                card.innerHTML = `
                    <div class="relative aspect-[2/3]">
                        <img src="${poster}" alt="${title}" class="w-full h-full object-cover" onerror="this.src='https://via.placeholder.com/300x450?text=æš‚æ— å°é¢'">
                        <div class="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/80 to-transparent p-2">
                            <span class="text-white text-xs">${type}</span>
                        </div>
                    </div>
                    <div class="p-2">
                        <h3 class="font-medium text-gray-800 truncate" title="${title}">${title}</h3>
                        <p class="text-xs text-gray-500 mt-1">${year}</p>
                    </div>
                `;
                
                // ç‚¹å‡»å¡ç‰‡æ˜¾ç¤ºè¯¦æƒ…
                card.addEventListener('click', function() {
                    showMovieDetails(movie);
                });
                
                resultsGrid.appendChild(card);
            });
        }
        
        // æ˜¾ç¤ºç”µå½±è¯¦æƒ…
        function showMovieDetails(movie) {
            console.log('æ˜¾ç¤ºç”µå½±è¯¦æƒ…:', movie);
            currentMovieData = movie;
            
            // æ›´æ–°æ¨¡æ€æ¡†ä¿¡æ¯
            modalTitle.textContent = movie.vod_name || 'æœªçŸ¥å½±ç‰‡';
            movieImage.src = movie.vod_pic || 'https://via.placeholder.com/300x450?text=æš‚æ— å°é¢';
            movieType.textContent = movie.vod_class || movie.type_name || 'æœªçŸ¥ç±»å‹';
            movieArea.textContent = movie.vod_area || 'æœªçŸ¥åœ°åŒº';
            movieYear.textContent = movie.vod_year || 'æœªçŸ¥å¹´ä»½';
            movieDirector.textContent = movie.vod_director || 'æœªçŸ¥å¯¼æ¼”';
            movieActor.textContent = movie.vod_actor || 'æœªçŸ¥æ¼”å‘˜';
            
            // å¤„ç†ç®€ä»‹å†…å®¹
            let contentText = 'æš‚æ— ç®€ä»‹';
            if (movie.vod_content) {
                // ç§»é™¤HTMLæ ‡ç­¾
                contentText = movie.vod_content.replace(/<[^>]*>/g, '');
            } else if (movie.vod_blurb) {
                contentText = movie.vod_blurb;
            }
            movieContent.textContent = contentText;
            
            // è§£æå’Œæ˜¾ç¤ºæ’­æ”¾é›†æ•°
            parseAndDisplayEpisodes(movie.vod_play_url);
            
            // æ˜¾ç¤ºæ¨¡æ€æ¡†
            movieModal.classList.remove('hidden');
        }
        
        // ä¿®æ”¹è§£æå’Œæ˜¾ç¤ºæ’­æ”¾é›†æ•°çš„å‡½æ•°
        function parseAndDisplayEpisodes(playUrlStr) {
            episodeContainer.innerHTML = '';
            
            console.log('è§£ææ’­æ”¾åœ°å€:', playUrlStr);
            
            if (!playUrlStr) {
                episodeContainer.innerHTML = '<p class="text-gray-500">æš‚æ— æ’­æ”¾æº</p>';
                return;
            }
            
            try {
                // è§£ææ’­æ”¾åœ°å€æ ¼å¼ - ä¿®å¤æœ«å°¾#å·é—®é¢˜
                const episodes = [];
                
                // å»é™¤æœ«å°¾å¯èƒ½çš„#å·
                const cleanUrlStr = playUrlStr.replace(/\s*#\s*$/, '');
                console.log('æ¸…ç†åçš„æ’­æ”¾åœ°å€:', cleanUrlStr);
                
                // åˆ†å‰²ä¸åŒçš„æ’­æ”¾æ ¼å¼
                const formats = cleanUrlStr.split('#');
                
                formats.forEach(format => {
                    if (!format.trim()) return;
                    
                    console.log('å¤„ç†æ ¼å¼:', format);
                    // åˆ†å‰²é›†æ•°æ ‡é¢˜å’Œåœ°å€
                    const parts = format.split('$');
                    if (parts.length >= 2) {
                        episodes.push({
                            title: parts[0].trim(),
                            url: parts[1].trim()
                        });
                    }
                });
                
                // å¦‚æœæ²¡æœ‰è§£æå‡ºé›†æ•°ï¼Œå°è¯•ç›´æ¥ä½¿ç”¨æ•´ä¸ªå­—ç¬¦ä¸²ä½œä¸ºURL
                if (episodes.length === 0 && cleanUrlStr.includes('http')) {
                    console.log('ç›´æ¥ä½¿ç”¨URLä½œä¸ºæ’­æ”¾æº');
                    episodes.push({
                        title: 'æ’­æ”¾',
                        url: cleanUrlStr
                    });
                }
                
                console.log('è§£æç»“æœ:', episodes);
                
                if (episodes.length === 0) {
                    episodeContainer.innerHTML = '<p class="text-gray-500">æš‚æ— æ’­æ”¾æº</p>';
                    return;
                }
                
                // åˆ›å»ºé›†æ•°æŒ‰é’®
                episodes.forEach((episode, index) => {
                    const button = document.createElement('button');
                    button.className = `episode-btn px-3 py-1.5 rounded-md text-sm ${index === 0 ? 'active' : 'bg-gray-100 text-gray-700'}`;
                    button.textContent = episode.title;
                    
                    // æ·»åŠ ç‚¹å‡»äº‹ä»¶
                    button.addEventListener('click', function() {
                        // ç§»é™¤å…¶ä»–æŒ‰é’®çš„æ¿€æ´»çŠ¶æ€
                        document.querySelectorAll('.episode-btn').forEach(btn => {
                            btn.classList.remove('active');
                            btn.classList.add('bg-gray-100', 'text-gray-700');
                        });
                        
                        // æ·»åŠ å½“å‰æŒ‰é’®çš„æ¿€æ´»çŠ¶æ€
                        this.classList.add('active');
                        this.classList.remove('bg-gray-100', 'text-gray-700');
                        
                        // æ’­æ”¾è§†é¢‘
                        playVideo(episode.url);
                    });
                    
                    episodeContainer.appendChild(button);
                });
                
                // è‡ªåŠ¨æ’­æ”¾ç¬¬ä¸€ä¸ªé›†æ•°
                playVideo(episodes[0].url);
                
            } catch (err) {
                console.error('è§£ææ’­æ”¾åœ°å€å¤±è´¥:', err);
                episodeContainer.innerHTML = `<p class="text-gray-500">æ’­æ”¾æºè§£æå¤±è´¥: ${err.message}</p>`;
            }
        }
        
        // ä¿®æ”¹æ’­æ”¾è§†é¢‘å‡½æ•°ï¼Œä½¿ç”¨hls.jsæ’­æ”¾è§†é¢‘
        function playVideo(videoUrl) {
            console.log('å°è¯•æ’­æ”¾è§†é¢‘:', videoUrl);
            
            const video = document.getElementById('videoPlayer');
            
            // æ¸…é™¤ä¹‹å‰çš„æ’­æ”¾å®ä¾‹
            if (hls) {
                hls.destroy();
            }
            
            try {
                if (Hls.isSupported()) {
                    hls = new Hls();
                    hls.loadSource(videoUrl);
                    hls.attachMedia(video);
                    
                    hls.on(Hls.Events.MANIFEST_PARSED, function() {
                        video.play();
                    });
                    hls.on(Hls.Events.ERROR, function(event, data) {
                        //console.error('HLSæ’­æ”¾é”™è¯¯:', data);
                        // alert('è§†é¢‘æ’­æ”¾å¤±è´¥: ' + data.details);
                    });
                } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
                    // Safariæµè§ˆå™¨åŸç”Ÿæ”¯æŒHLS
                    video.src = videoUrl;
                    video.addEventListener('loadedmetadata', function() {
                        video.play();
                    });
                } else {
                    console.error('è¯¥æµè§ˆå™¨ä¸æ”¯æŒHLSæ’­æ”¾');
                    alert('æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒHLSè§†é¢‘æ’­æ”¾');
                }
            } catch (err) {
                console.error('æ’­æ”¾è§†é¢‘å¤±è´¥:', err);
                alert('è§†é¢‘æ’­æ”¾å¤±è´¥ï¼Œè¯·å°è¯•å…¶ä»–é›†æ•°æˆ–æ£€æŸ¥ç½‘ç»œè¿æ¥: ' + err.message);
            }
        }
        
        // é‡ç½®UI
        function resetUI() {
            resultsGrid.innerHTML = '';
            searchInfo.classList.add('hidden');
            bottomSearchInfo.classList.add('hidden');
            paginationControls.classList.add('hidden');
            bottomPaginationControls.classList.add('hidden');
            errorMessage.classList.add('hidden');
            emptyState.classList.add('hidden');
            resultCount.textContent = '';
            pageInfo.textContent = '';
            bottomPageInfo.textContent = '';
            bottomResultCount.textContent = '';
        }
        
        // æ˜¾ç¤ºé”™è¯¯
        function showError(message) {
            errorText.textContent = message;
            errorMessage.classList.remove('hidden');
        }
        
        // è·å–å¹¶å¡«å……APIåˆ—è¡¨
        function fetchAndPopulateAPIList() {
            console.log('æ­£åœ¨è·å–APIåˆ—è¡¨...');
            
            // ä½¿ç”¨XMLHttpRequestç¡®ä¿æ›´å¥½çš„å…¼å®¹æ€§
            const xhr = new XMLHttpRequest();
            xhr.open('GET', 'https://corsapi.yuren0.us.kg?config=1', true);
            xhr.timeout = 15000; // 15ç§’è¶…æ—¶
            
            xhr.onload = function() {
                if (xhr.status === 200) {
                    try {
                        const response = JSON.parse(xhr.responseText);
                        console.log('APIåˆ—è¡¨è·å–æˆåŠŸ:', response);
                        
                        if (response.api_site) {
                            // æ¸…ç©ºç°æœ‰é€‰é¡¹
                            apiSelector.innerHTML = '';
                            
                            // éå†æ‰€æœ‰APIæ¥å£
                            for (const [key, site] of Object.entries(response.api_site)) {
                                if (site.name && site.api) {
                                    const option = document.createElement('option');
                                    // æ„å»ºå®Œæ•´çš„API URLï¼Œæ·»åŠ æœç´¢å‚æ•°
                                    const fullApiUrl = `${site.api}/?ac=videolist&wd=`;
                                    option.value = fullApiUrl;
                                    option.textContent = site.name;
                                    apiSelector.appendChild(option);
                                }
                            }
                            
                            // å¦‚æœæ²¡æœ‰æ·»åŠ ä»»ä½•é€‰é¡¹ï¼Œæ·»åŠ é»˜è®¤é€‰é¡¹
                            if (apiSelector.options.length === 0) {
                                const defaultOption = document.createElement('option');
                                defaultOption.value = 'https://corsapi-no18.yuren0.us.kg/?url=https://iqiyizyapi.com/api.php/provide/vod/?ac=videolist&wd=';
                                defaultOption.textContent = 'ğŸ¬çˆ±å¥‡è‰ºæº';
                                apiSelector.appendChild(defaultOption);
                            }
                        }
                    } catch (parseError) {
                        console.error('è§£æAPIåˆ—è¡¨JSONå¤±è´¥:', parseError);
                        // ä¿ç•™ç°æœ‰é€‰é¡¹
                    }
                } else {
                    console.error('è·å–APIåˆ—è¡¨å¤±è´¥ï¼ŒçŠ¶æ€ç :', xhr.status);
                    // ä¿ç•™ç°æœ‰é€‰é¡¹
                }
            };
            
            xhr.onerror = function() {
                console.error('è·å–APIåˆ—è¡¨ç½‘ç»œé”™è¯¯');
                // ä¿ç•™ç°æœ‰é€‰é¡¹
            };
            
            xhr.ontimeout = function() {
                console.error('è·å–APIåˆ—è¡¨è¯·æ±‚è¶…æ—¶');
                // ä¿ç•™ç°æœ‰é€‰é¡¹
            };
            
            xhr.send();
        }
        
        // äº‹ä»¶ç›‘å¬å™¨
        function setupEventListeners() {
            // æœç´¢æŒ‰é’®ç‚¹å‡»
            searchBtn.addEventListener('click', function() {
                const keyword = searchInput.value.trim();
                if (keyword) {
                    searchMovies(keyword, 1); // é‡ç½®åˆ°ç¬¬ä¸€é¡µ
                } else {
                    alert('è¯·è¾“å…¥æœç´¢å…³é”®è¯');
                }
            });
            
            // å›è½¦æœç´¢
            searchInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    const keyword = searchInput.value.trim();
                    if (keyword) {
                        searchMovies(keyword, 1); // é‡ç½®åˆ°ç¬¬ä¸€é¡µ
                    }
                }
            });
            
            // æ·»åŠ é‡è¯•æŒ‰é’®äº‹ä»¶ç›‘å¬å™¨
            retryBtn.addEventListener('click', function() {
                if (currentSearchKeyword) {
                    searchMovies(currentSearchKeyword, currentPage);
                }
            });
            
            // APIé€‰æ‹©å™¨æ”¹å˜æ—¶é‡ç½®æœç´¢
            apiSelector.addEventListener('change', function() {
                if (currentSearchKeyword) {
                    searchMovies(currentSearchKeyword, 1); // é‡ç½®åˆ°ç¬¬ä¸€é¡µ
                }
            });
            
            // ä¸Šä¸€é¡µæŒ‰é’®
            prevPageBtn.addEventListener('click', function() {
                if (currentPage > 1) {
                    searchMovies(currentSearchKeyword, currentPage - 1);
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                }
            });
            
            // ä¸‹ä¸€é¡µæŒ‰é’®
            nextPageBtn.addEventListener('click', function() {
                searchMovies(currentSearchKeyword, currentPage + 1);
                window.scrollTo({ top: 0, behavior: 'smooth' });
            });
            
            // åº•éƒ¨ä¸Šä¸€é¡µæŒ‰é’®
            bottomPrevPageBtn.addEventListener('click', function() {
                if (currentPage > 1) {
                    searchMovies(currentSearchKeyword, currentPage - 1);
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                }
            });
            
            // åº•éƒ¨ä¸‹ä¸€é¡µæŒ‰é’®
            bottomNextPageBtn.addEventListener('click', function() {
                searchMovies(currentSearchKeyword, currentPage + 1);
                window.scrollTo({ top: 0, behavior: 'smooth' });
            });
            
            // å…³é—­æ¨¡æ€æ¡†
            closeModal.addEventListener('click', function() {
                movieModal.classList.add('hidden');
                if (hls) {
                    hls.destroy();
                }
            });
            
            // ç‚¹å‡»æ¨¡æ€æ¡†èƒŒæ™¯å…³é—­
            movieModal.addEventListener('click', function(e) {
                if (e.target === movieModal) {
                    movieModal.classList.add('hidden');
                    if (hls) {
                        hls.destroy();
                    }
                }
            });
            
            // é˜»æ­¢æ¨¡æ€æ¡†å†…å®¹ç‚¹å‡»äº‹ä»¶å†’æ³¡
            document.querySelector('#movieModal > div').addEventListener('click', function(e) {
                e.stopPropagation();
            });
            
            // çª—å£å¤§å°æ”¹å˜æ—¶è°ƒæ•´æ’­æ”¾å™¨
            window.addEventListener('resize', function() {
                if (player) {
                    try {
                        player.resize();
                    } catch (err) {
                        console.warn('è°ƒæ•´æ’­æ”¾å™¨å¤§å°å¤±è´¥:', err);
                    }
                }
            });
        }
        
        // é¡µé¢åŠ è½½å®Œæˆåˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Moonå½±è§†æœç´¢é¡µé¢åŠ è½½å®Œæˆ');
            
            // é¦–å…ˆè·å–APIåˆ—è¡¨
            fetchAndPopulateAPIList();
            
            // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
            setupEventListeners();
            
            // åˆå§‹åŒ–è§†é¢‘æ’­æ”¾å™¨
            initVideoPlayer();
        });
        function updatePaginationControls() {
            // æ›´æ–°ä¸Šä¸€é¡µæŒ‰é’®çŠ¶æ€
            prevPageBtn.disabled = currentPage <= 1;
            bottomPrevPageBtn.disabled = currentPage <= 1;
    
            // ç®€å•çš„ä¸‹ä¸€é¡µé€»è¾‘ï¼šå¦‚æœæœ‰ç»“æœå°±æ˜¾ç¤ºä¸‹ä¸€é¡µæŒ‰é’®
            // å®é™…åº”ç”¨ä¸­å¯èƒ½éœ€è¦æ ¹æ®æ€»é¡µæ•°æ¥åˆ¤æ–­
            nextPageBtn.disabled = false;
            bottomNextPageBtn.disabled = false;
            
            // æ˜¾ç¤ºåˆ†é¡µæ§ä»¶
            paginationControls.classList.remove('hidden');
            bottomPaginationControls.classList.remove('hidden');
        }
    </script>
</body>
</html>
